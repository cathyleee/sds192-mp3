---
title: "Mini Project 3: CLASSIFICATION OF TRAILS BY DIFFERENT FACTORS"
author: "Cathy Lee, Lizette Carpenter, Ha Cao"
date: "7 April 2018"
output: 
  html_document:
    theme: united
    code_folding: hide
---

### Introduction and setup

Please see our Github repository for more details on this project.[^github]
Talk about `Macleish` package here.
```{r message = FALSE, warning = FALSE}
# load the libraries and data
#devtools::install_github("beanumber/macleish")
library(tidyverse)
library(sf)
library(macleish)
library(leaflet)
proj4_aea <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
```

### Classification of existing trails by level of difficulty based on length and elevation change
```{r message = FALSE, warning = FALSE}
trails <- macleish_layers[["trails"]] %>%
  mutate(computed_length = st_length(geometry))

# group trails with the same name
trails_combined <- trails %>%
  group_by(name) %>%
  summarize(color = first(color),
            length = sum(computed_length))

# join the two sf data frames to find intersection between trails and contours
# ELEV_M is elevation above or below sea level, in meters
trails_intersect <- st_intersection(trails_combined,
                macleish_layers[["contours_3m"]]) %>%
  st_cast("POINT") 

# summarize to see for each trail, how many times it changes its elevation, what is the highest/lowest contour, and what is the mean change in height
trails_change_elevation <- trails_intersect %>%
  group_by(name) %>%
  summarize(num_change = n(),
            min_height = min(ELEV_M),
            max_height = max(ELEV_M)) %>%
  mutate(mean_change = (max_height - min_height)/num_change)

# join trails_change_Elevation back to trails_intersect
trails_intersect <- st_join(trails_intersect, trails_change_elevation)
```

Our heuristic to rate the difficulty level of trails:

* Length: We rate this in the scale of 10. The longest trail (2575.217 m) has length score 10/10. We calculate the scores for the other trails by dividing their length by the biggest length and multiplying by 10, and round up to integers. 

* Elevation: This has 2 smaller factors: the number of times a trail changes in elevation and the mean change in height each time. Each of these 2 factors are measured in the scale of 5, so they sum up to the scale of 10. 

- The trail with the most changes in elevation has a score of 5.

- The trail with the biggest mean change has a score of 5. 

Then we sum the partial scores into the total score in the scale of 20:

* From 0 - 7: Easy Trail
* From 8 - 14: Moderate Trail
* From 15- 20: Hard Trail

```{r message = FALSE, warning = FALSE}
trails_intersect$length <- as.numeric(trails_intersect$length, "")
# calculate the scores
max_length <- max(trails_intersect$length)
max_num_change <- max(trails_intersect$num_change)
max_mean_change <- max(trails_intersect$mean_change)

trails_intersect <- trails_intersect %>%
  mutate(score_length = round(length*10/max_length),
         score_num = round(num_change*5/max_num_change),
         score_mean = round(mean_change*5/max_mean_change)) %>%
  mutate(total_score = score_length + score_num + score_mean) %>%
  mutate(level = if_else(total_score > 14, "hard", if_else(total_score > 7, "moderate", "easy"))) 

# summarize into a shorter version
trails_short <- trails_intersect %>%
  group_by(name.x) %>%
  summarize(score = first(total_score),
            level = first(level))

st_geometry(trails_short) <- NULL

# join trails_short back to trails_combined
trails_mapped <- full_join(trails_combined, trails_short, by = c("name" = "name.x")) 
```

```{r message = FALSE}
# change orders of factors in the variable `level`
trails_mapped$level = factor(trails_mapped$level, levels = c("easy", "moderate", "hard"))

# plot the trails and their levels into the map
pal <- colorFactor(palette = c("darkorange", "blue", "red"), domain = trails_mapped$level)

pal_contours <- colorNumeric(palette = "viridis", domain = macleish_layers[["contours_3m"]]$ELEV, reverse = TRUE)

leaflet(data = trails_mapped) %>%
  addTiles() %>%
  addPolylines(data = macleish_layers[["contours_3m"]], color = ~pal_contours(ELEV_M), weight = 2, group = "10' Contours") %>%
  addLegend("bottomright", pal = pal_contours, values = ~macleish_layers[["contours_3m"]]$ELEV_M, title = "10' Contours Elevation in meters", opacity = 1) %>%
  addPolylines(color = ~pal(level), label = ~name, group = "Trails", opacity = 0.8) %>%
  addLegend("bottomright", pal = pal, values = ~level, title = "Difficulty Level", opacity = 1) %>%
  addLayersControl(
    overlayGroups = c("Trails", "10' Contours"),
    options = layersControlOptions(collapsed = FALSE)
  ) 
```

From the map, the Easy Out trail is weird because its two segments are not continuous. After we asked Professor Reid, it turns out that it is just a little connector that allows people to get out to the Eastern Loop trail without continuing around the loops of the other trails.

In the map, we added layer control for trails and 10' contours. We plotted the contours such that they change color by elevation. The darker colors (closer to purple) mean higher elevations, and the lighter colosr (further away from purple) mean lower elevations. The elevation increases as we approach the inside of Macleish.

We can see there is a positive correlation between the lengths of the trails and the difficulty level. Obviously, length contribute half of the difficulty in our heuristic, but also the longer trails tend to be closer to the inside of Macleish, which mean they are more likely to cross higher contours. Also, because they are longer, they cut a lot more different contours constantly, which means they change their elevations more often, making it harder to hike/bike on those trails. 

### Classification of trails by biodiversity/vegetation
```{r}
# join the two sf data frames to find intersection between trails and forests
trails_forests <- st_intersection(trails_combined,
                macleish_layers[["forests"]]) 
addNA(trails_forests$Sheet1__Na)
trails_forests <- trails_forests %>%
  rename(forest_type = Sheet1__Na) # rename to make the variable name more telling
```

```{r}
# find how many forests each trail passes by and how many unique forest types it passes by
trails_forests$length <- as.numeric(trails_forests$length, "")
trails_forests <- trails_forests %>%
  group_by(name) %>%
  summarize(distinct_veg_type = n_distinct(VegType_21),
            distinct_forest_type = n_distinct(forest_type),
            num_forests_crossed = n(), 
            length = first(length)) %>%
# add a variable to show distance hikers/bikers have to go to see a forest
  mutate(distance_to_forest = length/num_forests_crossed)
```

Our heuristic to rate the biodiversity/vegetation of trails:

* Number of forests each trail comes across: We rate this in the scale of 10. The trail that goes through most forests (11) has score 10/10. We calculate the scores for the other trails by dividing their number of forests crossed by the biggest number of forests crossed and multiplying by 10, and round up to integers. This indicates how many times the trail changes its natural scenery.

* Number of distinct forest types each trail comes across: We rate this in the scale of 10. The trail goes through most diverse types of forest (7) has score 10/10. We calculate the scores in the same way above. This shows how diverse the vegetation along the trail is. 

* Average distance between forests: We rate this in the scale of 4, because even the longest average distance 367.89 m (length/number of forests) is pretty small and within walking distance, so we weigh it less. The trail with the shortest average distance has the score of 4. We want to include this because we want to make the number of forests along the trail relative to its length, because obviously longer trails are likely to come across more forests. 

Then we sum the partial scores into the total score in the scale of 20:

* From 0 - 8: Least Biologically Diverse Trail
* From 9 - 16: More Biologically Diverse Trail
* From 17- 24: Most Biologically Diverse Trail

```{r message = FALSE, warning = FALSE}
# calculate the scores
max_num_forests <- max(trails_forests$num_forests_crossed)
max_num_distinct_forests <- max(trails_forests$distinct_forest_type)
min_avg_distance <- min(trails_forests$distance_to_forest)

trails_forests <- trails_forests %>%
  mutate(score_num = round(num_forests_crossed*10/max_num_forests),
         score_distinct = round(distinct_forest_type*10/max_num_distinct_forests),
         score_avg_distance = round(min_avg_distance*4/distance_to_forest)) %>%
  mutate(total_score = score_num + score_distinct + score_avg_distance) %>%
  mutate(level = if_else(total_score > 16, "Most Biologically Diverse Trail", if_else(total_score > 8, "Moderately Biologically Diverse Trail", "Least Biologically Diverse Trail"))) %>%
  mutate(num_forests_range = if_else(num_forests_crossed > 5, "6 - 10 forests", "1 - 5 forests")) %>%
  mutate(num_distinct_forests_range = if_else(distinct_forest_type > 4, "5 - 7 types of forests", "1 - 4 types of forests"))
```

```{r}
st_geometry(trails_forests) <- NULL

# join trails_forests back to trails_combined
trails_forests <- full_join(trails_combined, trails_forests, by = c("name" = "name")) 
```

```{r}
# change orders of factors in the variable `level`, 'num_forests_range`, and `num_distinct_forests_range`
trails_forests$level = factor(trails_forests$level, levels = c("Least Biologically Diverse Trail", "Moderately Biologically Diverse Trail", "Most Biologically Diverse Trail"))
trails_forests$num_forests_range = factor(trails_forests$num_forests_range, levels = c("1 - 5 forests", "6 - 10 forests"))
trails_forests$num_distinct_forests_range = factor(trails_forests$num_distinct_forests_range, levels = c("1 - 4 types of forests", "5 - 7 types of forests"))

# plot the trails and their levels into the map
pal_level <- colorFactor(palette = c("red", "blue", "darkgreen"), domain = trails_forests$level)
pal_range <- colorFactor(palette = c("red", "blue"), domain = trails_forests$num_forests_range)
pal_distinct <- colorFactor(palette = c("red", "blue"), domain = trails_forests$num_distinct_forests_range)

leaflet(data = trails_forests) %>%
  addTiles() %>%
  addPolylines(color = ~pal_level(level), label = ~name, group = "Overall Biodiversity Level", opacity = 0.8) %>%
  addLegend("bottomright", pal = pal_level, values = ~level, title = "Biodiversity Level", opacity = 1) %>%
  addPolylines(color = ~pal_range(num_forests_range), label = ~name, group = "Number of Forests", opacity = 0.8) %>%
  addLegend("bottomright", pal = pal_range, values = ~num_forests_range, title = "Number of Forests crossed", opacity = 1) %>%
  addPolylines(color = ~pal_distinct(num_distinct_forests_range), label = ~name, group = "Number of Distinct Forest Types", opacity = 0.8) %>%
  addLegend("bottomright", pal = pal_distinct, values = ~num_distinct_forests_range, title = "Number of Distinct Forest Types seen", opacity = 1) %>%
  addLayersControl(
    overlayGroups = c("Overall Biodiversity Level", "Number of Forests", "Number of Distinct Forest Types"),
    options = layersControlOptions(collapsed = FALSE)
  ) 
```

### Classification of trails by the number of Arts Afield Sites they see

```{r}
# read in the Arts Afield Sites shapefile
arts_afield <- st_read("Arts_Afield/Arts_Afield_20160406.shp")
afield_es <- st_transform(arts_afield, crs = st_crs(trails_mapped))

# create buffers of 300m around each Arts Afield site
afield_buffer <- afield_es %>%
  st_transform(proj4_aea) %>%
  st_buffer(dist = 50) %>%
  st_transform(4326)

# calculate intersection of field with Arts Afield Site buffer
trail_afield_intersect <- st_intersection(trails, afield_buffer) 

# calculate the number of intersections each trail has with Arts Afield Sites
# In other words, how many Arts Afield Sites are within viewing distance of each trail?
trail_afield_num_intersect <- trail_afield_intersect %>%
  group_by(name) %>% 
  summarise(num_intersections = n())

st_geometry(trail_afield_num_intersect) <- NULL

# join trail_afield_plot with trails so we aren't just plotting trails within the buffer area
trail_afield_full <- full_join(trails_combined, trail_afield_num_intersect, by = c("name" = "name"))

# replace null values with 0
trail_afield_mapped <- trail_afield_full %>% 
  select(-color) 
trail_afield_mapped[is.na(trail_afield_mapped)] <- 0

# categorise the number of intersections
trail_afield_mapped <- trail_afield_mapped %>%
  mutate(level = if_else(num_intersections >= 3, "Many Arts Afield Sites", if_else(num_intersections >= 1, "Moderate Arts Afield Sites", "No Arts Afield Sites")))

# change the order of factors in the variable `level`
trail_afield_mapped$level = factor(trail_afield_mapped$level, levels=c("No Arts Afield Sites", "Moderate Arts Afield Sites", "Many Arts Afield Sites"))
# plot the trails and their levels into the map
pal <- colorFactor(palette = c("darkorange", "blue", "red"), domain = trail_afield_mapped$level)

# Plot the data
leaflet(data = trail_afield_mapped) %>%
  addTiles() %>%
  addPolylines(color = ~pal(level), label = ~name, group="Trails", opacity=1.0) %>%
  addLegend("bottomright", pal = pal, values = ~level) %>%
  addMarkers(data=afield_es, popup = ~ident, group="Arts Afield Sites") %>%
  addPolygons(data = afield_buffer, group="Arts Afield Sites") %>%
  addLayersControl(
    overlayGroups = c("Trails", "Arts Afield Sites"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

[^github]: https://github.com/cathyleee/sds192-mp3
<<<<<<< HEAD
=======

>>>>>>> a7d574f756b894e07c64a0a14d8439962c7a1046
